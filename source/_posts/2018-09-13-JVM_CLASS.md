---
title: 深入理解JAVA虚拟机（三）  CLASS文件结构
date: 2018/09/13 20:02:13
updated: 
tag: 
- JVM
- 字节码
categories:
- Java

---

JAVA语言以及其他运行于JVM上的语言（JRuby、Groovy等）中所定义各种变量、逻辑，通过不同的编译器最终都会被转成字节码文件用于虚拟机执行，甚至一些Java语言无法支持的特性，字节码文件都可以支持，可以看出，字节码文件的重要性。

<!-- more -->

# 概述

本质：由一组**8位**字节，严格**按照顺序**，**紧凑**排列组成的**二进制流**。
* 8位：CLASS文件的基础单位，超过8为的数据在存放时采用***高位在前***的存储方式存储。
ps：高位在前指的时最高的字节在地址的低位（即访问时先访问到）
* 按照顺序：按照虚拟机规范中对字节码文件的定义
* 紧凑：各数据之间没有任何分隔符
* 二进制流：只要时符合规范的二进制流虚拟机都可识别，也就意味着**CLASS文件的来源不局限于文件系统**。

数据结构：采用了**无符号数**和**表**这两种伪结构存储数据。  
* 无符号数：基本数据类型，以u1、u2、u4和u8分别对应1字节、2字节、4字节和8字节，用以描述数字、索引引用、数量值或UTF-8字符串等。  
* 表：由多个无符号数或其他数据项构成，习惯以_info结尾。用以描述由层次关系的复合结构数据。 
* 集合（拓展）：用来描述多个连续的无符号数或表，通常会带一个前置容量计数器

# 字节码文件结构

## 结构概览

| 类型 | 名称 | 数量 | 说明 |
|:--:|:--|:--:|:--|
| u4 | 魔数（magic） | 1 |   |
| u2 | 次版本号（minor_version） | 1 |   |
| u2 | 主版本号（major_version） | 1 |   |
| u2 | 常量池常量数（constant_pool_count） | 1 | 与constant_pool构成一个表的集合 |
| cp_info | 常量池（constant_pool） |  常量池常量数| 每个常量都是一个表，存放放量相关信息 |
| u2 | 权限标志（access flags） | 1 |  |
| u2 | 本类名（this_class） | 1 | 指向常量池中本类的全限定名字符串的索引（第几个） |
| u2 | 父类名（this_class） | 1 | 指向常量池中父类的全限定名字符串的索引 |
| u2 | 接口数量（interfaces_count） | 1 | 与interfaces组成一个u2的无符号集合 |
| u2 | 接口（interfaces） | 接口数量 | 指向常量池中接口的全限定名字符串的索引 |
| u2 | 字段数量（filed_count） | 1 | 与filed_info组成字段集合 |
| filed_info | 字段（filed） | 字段数量 | 数据结构较复杂 |
| u2 | 方法数量（method_info） | 1 | 与method_info组成方法集合 |
| method_info | 方法（method） | 方法数量 | 数据结构较复杂 |
| u2 | 属性数量（attribute_count） | 1 | 与attribute_info组成属性集合 |
| attribute_info | 属性（attribute） | 属性数量 | 数据结构较复杂 |

## 魔数（u4）

固定值：CA FE BA BE 
用以标识当前文件是给JVM执行的字节码文件

## 次版本号（u2）

标识CLASS文件的次版本号

## 主版本号（u2）

标识CLASS文件的主版本号（JVM执行的版本，非实际JAVA开发版本），从JAVA1.1 到JAVA1.8 分别对应从 45 到 52。

## 常量池常量数（u2）及常量池（cp_info）

### 常量池常量数

* 索引从1开始，即实际常量数是=常量池常量数-1
* 索引0主要是为了“表示不引用任何常量池常量”

### 常量池

常量池主要存放：字面量和符号引用
* 字面量：文本字符串、声明为final的常量值。
* 符号引用：类和接口的全限定名、字段的名称和描述符、方法的名称和描述符

全限定名：表示类的路径及名称；如"java/lang/Object;"，一般以；标识全限定名的结束。
简单名称：标识字段及方法的名称，如字段x，方法int()对应的就是"x，int"
描述符：描述字段或方法；如"[Ljava/lang/Object"表示Object[]；"(C[I)V"表示返回值为void，参数为（char，int[]）的方法，诸如此类。

描述符含义
* B &nbsp;&nbsp;&nbsp;&nbsp; byte
* C &nbsp;&nbsp;&nbsp;&nbsp; char
* D &nbsp;&nbsp;&nbsp;&nbsp; double
* F &nbsp;&nbsp;&nbsp;&nbsp; float
* I &nbsp;&nbsp;&nbsp;&nbsp; int
* ***J*** &nbsp;&nbsp;&nbsp;&nbsp; long
* S &nbsp;&nbsp;&nbsp;&nbsp; short
* ***Z*** &nbsp;&nbsp;&nbsp;&nbsp; boolean
* L &nbsp;&nbsp;&nbsp;&nbsp; 对象
* [ &nbsp;&nbsp;&nbsp;&nbsp; 数组，有多个则代表多维，数组类型为[后紧接的描述符
* ()  &nbsp;&nbsp;&nbsp; 方法，括号外为返回值类型，括号内为参数类型（各参数之间无逗号） 

常量池中，根据常量类型的不同，其具体的表数据结构也略有不同，待后续整理，具体请参阅[JAVA虚拟机规范-4.4章节](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4)。

ps：因常量池UTF8字符长度的限制，方法最长长度不能大于65535。

## 访问标志（u2）

表示当前类的访问标志，共可设置16种标志，各标志含义如下

|编号|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|0x|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|

|编号|标志名称|标志值|含义|
|:--|:--|:--|:--|
|1|ACC_PUBLIC|0x0001|是否为public类型|
|5|ACC_FINAL|0x0010|是否为final类型，只有类才可设置|
|6|ACC_SUPER|0x0020|改之在1.02后必须为1|
|10|ACC_INTERFACE|0x0200|是否为接口|
|11|ACC_ABSTRACT|0x0400|是否为抽象类型，对于接口及抽象类，值为真，其他为假|
|13|ACC_SYNTHETIC|0x1000|这个类不是由用户代码生成（动态标志）|
|14|ACC_ANNOTATION|0x2000|是否为注解|
|15|ACC_ENUM|0x4000|是否为枚举类|

## 本类名（u2）

指向常量池中，类型为CONSTANT_Class_info的常量索引（tag为7）。

## 父类名（u2）

指向常量池中，类型为CONSTANT_Class_info的常量索引（tag为7）。
除了Object外，所有的类的父类索引都不为0（因为所有类都继承自Object）

## 接口集合

### 接口数量（u2）

标识当前类实现的接口的数量

### 接口（u2）

指向常量池中，类型为CONSTANT_Class_info的常量索引（tag为7）。
若类实现多个接口，则按类实现顺序，从左向右一次放入接口集合中。

## 字段表集合

1、字段集合中不会有从父类或父接口中继承来的字段。但可能会出现代码中没有的字段。
2、对于字节码而言，只要字段的描述不以相同，即使字段简单名称相同，也会被认为是不同的字段，而JAVA中简单名称必须不同。

### 字段数量（u2）

类或接口中，类级变量及实例级变量的数量（**不包括方法内部声明的变量**）。

### 字段表

字段表主要包含
1. u2 字段权限标志（access_flags）
2. u2 字段名对应的简单名称在常量池中的索引(name_index)
3. u2 字段描述对应的描述符在常量池中索引(descript_index)
4. u2 属性表数量（attribute_count）
4. attribute_info 属性表信息（attributet）

其中
1.字段权限标志，参照如下表
|编号|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|0x|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|

|编号|标志名称|标志值|含义|
|:--|:--|:--|:--|
|1|ACC_PUBLIC|0x0001|是否为public类型|
|2|ACC_PRIVATE|0x0002|是否为private类型|
|3|ACC_PROTECTED|0x0004|是否为protected类型|
|4|ACC_STATIC|0x0008|是否为static|
|5|ACC_FINAL|0x0010|是否为final型|
|7|ACC_VOLATILE|0x0040|是否为volatile|
|8|ACC_TRANSIENT|0x0080|是否为transient|
|13|ACC_SYNTHETIC|0x1000|是否由编译器生成|
|15|ACC_ENUM|0x4000|是否为enum|

其中1、2、3最多只能1个为真；5、7不能同时为真；接口中的字段1、4、5必须为真

## 方法集合

1、方法集合中不会出现没有被重写（override）的父类或父接口方法。但可能会出现代码中没有的方法（典型的如类构造器<clinit> 及初始化方法<init>）。
2、对于字节码而言，只要字段的描述不以相同，即使字段简单名称相同，也会被认为是不同的字段，而JAVA中简单名称必须不同。

### 方法数量（u2）

类或接口中，方法的数量。

### 方法表

方法表主要包含
1. u2 方法权限标志（access_flags）
2. u2 方法名对应的简单名称在常量池中的索引(name_index)
3. u2 方法描述对应的描述符在常量池中索引(descript_index)
4. u2 属性表数量（attribute_count）
4. attribute_info 属性表信息（attributet）

其中
1.字段权限标志，参照如下表
|编号|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|0x|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|

|编号|标志名称|标志值|含义|
|:--|:--|:--|:--|
|1|ACC_PUBLIC|0x0001|是否为public类型|
|2|ACC_PRIVATE|0x0002|是否为private类型|
|3|ACC_PROTECTED|0x0004|是否为protected类型|
|4|ACC_STATIC|0x0008|是否为static|
|5|ACC_FINAL|0x0010|是否为final型|
|6|ACC_SYNCHRONIZED|0x0020|是否为synchronized|
|7|ACC_BRIDGE|0x0040|是否编译器生成的桥接方法|
|8|ACC_VARIGES|0x0080|是否接受不定参数|
|9|ACC_NATIVE|0x010|是否本地方法|
|11|ACC_ABSTRACT|0x0400|是否抽象方法|
|12|ACC_STRICTFP|0x0800|是否为strictfp|
|11|ACC_SYNTHETIC|0x0400|是否由编译器自动产生|

## 属性集合

属性表集合用以描述某些场景的专有信息，CLASS、FILED、METHOD都有携带自己的属性表集合。

### 属性数量（u2）

描述当前属性表的属性数量

### 属性表

属性表至少需包含以下（各类属性表结构略有区别）；

1. u2 属性名对应的简单名称在常量池中的索引(attribute_name_index)
2. u4 属性长度(attribute_length)
4. u1 属性表信息（长度为属性长度）


属性的描述，在JDK1.7时共有21中属性分类。

根据属性类型的不同，其具体的表数据结构也略有不同，具体请参阅[JAVA虚拟机规范-4.7章节](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7)。

ps：属性的CODE类型中，虽规定CODE的长度为u4，但实际指令最长长度不能大于65535。




疑问1：在类中，类的静态变量赋值时（如static a = 1;），“1”这个值存放位置。
答：作为指令，存放在CLASS的属性表中
疑问2：对象实例的this，在字节码文件中是否有安排位置存放；
疑问3：桥接方法？
疑问4：不定参数的方法描述？
